runtime: container
build:
  dockerfile: Dockerfile
  dockerBuildPath: .
startCommand:
  type: http
  env:
    TRANSPORT: http
  configSchema:
    type: object
    # Allow extra keys for auth/providers coming from Test profile
    additionalProperties: true
    properties:
      apiKey:
        type: string
        title: 'API Key'
        description: 'Your API key'
        format: password
      browserUrl:
        type: string
        format: uri
        title: 'DevTools WebSocket URL'
        description: 'Existing Chrome DevTools WebSocket URL to connect to (browserURL).'
      headless:
        type: boolean
        title: 'Headless'
        description: 'Run Chrome in headless mode.'
        default: true
      executablePath:
        type: string
        title: 'Executable Path'
        description: 'Absolute path to a Chrome executable inside the container.'
      isolated:
        type: boolean
        title: 'Isolated User Data Dir'
        description: 'Launch Chrome with an isolated user data dir.'
        default: true
      customDevtools:
        type: string
        title: 'Custom DevTools Frontend'
        description: 'Path or URL to a custom DevTools frontend bundle.'
      channel:
        type: string
        enum: ['stable', 'beta', 'canary', 'dev']
        title: 'Chrome Channel'
        description: 'Chrome channel to use when launching the bundled browser.'
      logFile:
        type: string
        title: 'Log File'
        description: 'Path inside the container where debug logs should be written.'
      viewport:
        type: string
        title: 'Viewport'
        description: 'Viewport size for launched Chrome instances (e.g., 1280x720).'
      proxyServer:
        type: string
        title: 'Proxy Server'
        description: 'Proxy definition to forward Chrome network traffic through.'
      acceptInsecureCerts:
        type: boolean
        title: 'Accept Insecure Certs'
        description: 'Ignore TLS certificate errors when launching Chrome.'
      experimentalDevtools:
        type: boolean
        title: 'Experimental DevTools'
        description: 'Enable DevTools automation targets (experimental).'
      chromeArg:
        type: array
        title: 'Additional Chrome Arguments'
        description: 'Additional command-line switches to pass to Chrome.'
        items:
          type: string
      browserbase:
        type: object
        title: 'Browserbase'
        description: 'Launch a remote Chrome via Browserbase (scanner-friendly).'
        additionalProperties: false
        properties:
          apiKey:
            type: string
            title: 'API Key'
            description: 'Browserbase API key used to create sessions.'
            format: password
          projectId:
            type: string
            title: 'Project ID'
            description: 'Browserbase project ID to associate sessions with.'
          contextId:
            type: string
            title: 'Context ID'
            description: 'Optional persistent context ID to reuse saved browser state.'
          persist:
            type: boolean
            title: 'Persist Context'
            description: 'Whether to persist the Browserbase context.'
            default: true
        required: ['apiKey']

  # Map user configuration to environment variables and CLI flags
  commandFunction: |
    config => {
      const env = { TRANSPORT: 'http' };
      const bb = config.browserbase || {};

      // Prefer nested browserbase.* but allow top-level apiKey as a fallback
      if (bb.apiKey || config.apiKey) env.BROWSERBASE_API_KEY = bb.apiKey || config.apiKey;
      if (bb.projectId) env.BROWSERBASE_PROJECT_ID = bb.projectId;
      if (bb.contextId) env.BROWSERBASE_CONTEXT_ID = bb.contextId;
      if (typeof bb.persist !== 'undefined') env.BROWSERBASE_PERSIST = String(bb.persist);

      const args = [];
      if (config.browserUrl) args.push('--browserUrl', String(config.browserUrl));
      if (typeof config.headless === 'boolean') args.push(config.headless ? '--headless' : '--no-headless');
      if (config.executablePath) args.push('--executablePath', String(config.executablePath));
      if (config.isolated) args.push('--isolated');
      if (config.customDevtools) args.push('--customDevtools', String(config.customDevtools));
      if (config.experimentalDevtools) args.push('--experimentalDevtools');
      if (config.channel) args.push('--channel', String(config.channel));
      if (config.logFile) args.push('--logFile', String(config.logFile));
      if (config.viewport && typeof config.viewport === 'string') args.push('--viewport', config.viewport);
      if (config.proxyServer) args.push('--proxyServer', String(config.proxyServer));
      if (typeof config.acceptInsecureCerts === 'boolean') args.push(config.acceptInsecureCerts ? '--acceptInsecureCerts' : '--no-acceptInsecureCerts');
      if (Array.isArray(config.chromeArg)) for (const v of config.chromeArg) args.push('--chrome-arg', String(v));

      return {
        command: 'node',
        args: ['build/src/index.js', ...args],
        env,
      };
    }

exampleConfig:
  channel: stable
  headless: true
  isolated: true
  viewport: '1280x720'
  browserbase:
    # apiKey is provided via Test profile or secret store â€” do not hardcode
    projectId: 'bc914a3df39095025464368c5cabf0af8ae97b1f'
    persist: true
